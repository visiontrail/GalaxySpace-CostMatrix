# 数据可视化更新说明

## 更新日期
2026-01-05

## 更新内容

### 1. 部门数据显示调整
- **之前**：显示10个部门
- **现在**：固定显示15个部门
- **超出处理**：如果部门数量超过15个，第16条会显示为"其他"，汇总剩余所有部门的数据
- **汇总字段**：
  - 总成本（求和）
  - 总工时（求和）
  - 人员数量（求和）
  - 饱和度（求平均）

### 2. 项目数据显示调整
- **之前**：显示10个项目
- **现在**：固定显示20个项目
- **超出处理**：如果项目数量超过20个，第21条会显示为"其他"，汇总剩余所有项目的数据
- **汇总字段**：
  - 总成本（求和）
  - 机票成本（求和）
  - 酒店成本（求和）
  - 火车票成本（求和）
  - 订单数量（求和）

### 3. 实际测试结果

#### 当前数据情况
```
部门数量: 15个（正好15个，无"其他"）
项目数量: 21条（前20个 + "其他"汇总45个项目）
```

#### "其他"条目示例
```
项目代码: 其他
项目名称: 其他项目（45个）
总成本: ¥212,061.00
```

### 4. 修改的文件

#### 后端文件
1. **backend/app/services/excel_processor.py**
   - 修改 `aggregate_project_costs()` 方法，增加 `top_n=20` 参数
   - 修改 `calculate_department_costs()` 方法，增加 `top_n=15` 参数
   - 新增 `_apply_top_n_with_others()` 辅助方法，统一处理"其他"汇总逻辑

2. **backend/app/api/routes.py**
   - 更新 `/analyze` 端点调用，指定 `top_n=20` 和 `top_n=15`
   - 更新注释说明，project_top10 现在实际返回21条数据

3. **analysis_service.py** (根目录独立分析服务)
   - 同步更新 `generate_dashboard_data()` 方法
   - 新增 `_prepare_top_items_with_others()` 辅助方法

### 5. 技术实现细节

#### 汇总逻辑
```python
def _apply_top_n_with_others(results, top_n, name_key):
    """
    1. 如果总数 <= top_n：返回全部数据
    2. 如果总数 > top_n：
       - 返回前 top_n 条
       - 将剩余数据汇总为"其他"条目
       - "其他"条目自动计算各字段的和/平均值
    """
```

#### 自动重载
- 后端使用 uvicorn 的 WatchFiles 功能，自动检测代码变更并重载
- 无需手动重启服务

### 6. 前端显示

#### 注意事项
前端Dashboard.tsx中有部分图表仍使用 `.slice(0, 10)` 限制显示数量：
- 部门成本柱状图：显示前10个（第162行）
- 部门平均工时柱状图：显示前10个（第259-260行）

**表格显示**：
- 部门表格：显示全部15条（或16条含"其他"）
- 项目表格：显示全部21条（包含"其他"）

#### 建议
如果需要图表也显示全部数据，可以：
1. 删除 `.slice(0, 10)` 限制
2. 或者修改为 `.slice(0, 15)` 以匹配新的数量

### 7. 测试验证

#### API测试
```bash
# 测试命令
curl -s "http://localhost:8000/api/analyze?file_path=./uploads/文件名.xlsx" -X POST

# 验证项
✓ 部门数量 = 15（或16含"其他"）
✓ 项目数量 = 21（20 + "其他"）
✓ "其他"条目包含正确的汇总数据
```

#### 单元测试
已通过以下场景测试：
- ✓ 20个部门 → 返回16条（15个具体部门 + 1个"其他"）
- ✓ 25个项目 → 返回21条（20个具体项目 + 1个"其他"）
- ✓ 15个部门 → 返回15条（无"其他"）
- ✓ 20个项目 → 返回20条（无"其他"）

### 8. 未来扩展

如果组织架构变化导致部门数量增加：
- 系统会自动保持显示15个部门
- 超出的部门会自动汇总到"其他"
- 无需修改代码，完全自动化

如果项目数量继续增长：
- 系统会自动保持显示20个项目
- 超出的项目会自动汇总到"其他"
- "其他"项目名称会显示汇总的项目数量，如"其他项目（45个）"

## 总结

此次更新实现了：
1. ✅ 部门数据固定显示15条
2. ✅ 项目数据固定显示20条
3. ✅ 超出数据自动汇总到"其他"
4. ✅ 保持数据完整性（无信息丢失）
5. ✅ 自动化处理，无需手动维护
6. ✅ 向后兼容，不影响现有功能

