# CostMatrix - 企业差旅分析平台（后端 API）

## 📝 项目简介

CostMatrix 是一个基于 FastAPI + Pandas + OpenPyXL 的企业差旅分析平台后端服务。
核心功能包括：

- 📊 **数据分析**: 读取 Excel (.xlsx) 进行差旅成本分析
- 🔍 **异常检测**: 交叉验证考勤与差旅记录，识别异常情况
- 📈 **可视化支持**: 生成 Dashboard 所需的 JSON 数据
- 📤 **Excel 导出**: 在原文件中追加分析结果 Sheet（保留原样式）

---

## 🏗️ 项目结构

```
CostMatrix/
├── main.py                  # FastAPI 主入口
├── data_loader.py           # 数据加载和清洗模块
├── analysis_service.py      # 核心分析逻辑
├── export_service.py        # Excel 导出服务
├── requirements.txt         # Python 依赖
├── .gitignore              # Git 忽略文件
└── README.md               # 项目说明
```

---

## 🚀 快速开始

### 1. 环境准备

确保已安装 Python 3.8+：

```bash
python --version
```

### 2. 安装依赖

```bash
# 创建虚拟环境（推荐）
python -m venv venv

# 激活虚拟环境
# macOS/Linux:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# 安装依赖包
pip install -r requirements.txt
```

### 3. 启动服务

```bash
python main.py
```

服务将在 `http://localhost:8000` 启动。

访问 API 文档：
- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

---

## 📡 API 端点

### 1. 健康检查

**GET** `/health`

检查服务运行状态。

**响应示例：**
```json
{
  "status": "healthy",
  "service": "CostMatrix API"
}
```

---

### 2. 数据分析

**POST** `/api/analyze`

上传 Excel 文件，返回分析结果 JSON。

**请求：**
- Content-Type: `multipart/form-data`
- Body: `file` (Excel 文件)

**响应示例：**
```json
{
  "success": true,
  "data": {
    "kpi": {
      "total_cost": 1234567.89,
      "total_orders": 856,
      "anomaly_count": 23,
      "over_standard_count": 45,
      "urgent_booking_ratio": 12.5
    },
    "department_metrics": [
      {
        "一级部门": "研发部",
        "总成本": 456789.12,
        "总工时": 3520.0,
        "人员数量": 20,
        "饱和度": 95.8
      }
    ],
    "top_projects": [
      {
        "项目代码": "05010013",
        "总成本": 123456.78,
        "机票成本": 80000.00,
        "酒店成本": 30000.00,
        "火车票成本": 13456.78,
        "订单数量": 45
      }
    ],
    "anomalies": [
      {
        "Type": "Conflict",
        "姓名": "张三",
        "日期": "2024-01-15",
        "考勤状态": "上班",
        "差旅类型": "机票",
        "差旅金额": 1500.0,
        "一级部门": "研发部",
        "描述": "考勤显示上班但同日有异地差旅消费"
      }
    ],
    "booking_behavior": {
      "total_orders": 856,
      "urgent_orders": 107,
      "urgent_ratio": 12.5,
      "avg_advance_days": 8.5
    },
    "generated_at": "2024-01-20 10:30:45"
  },
  "message": "分析完成"
}
```

---

### 3. 导出分析结果

**POST** `/api/export`

上传 Excel 文件，返回包含分析结果的新 Excel 文件。

**请求：**
- Content-Type: `multipart/form-data`
- Body: `file` (Excel 文件)

**响应：**
- Content-Type: `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- 文件名: `{原文件名}_分析结果.xlsx`

**新增 Sheet：**
1. **Dashboard_Data**: 包含 KPI、项目 Top 10、部门指标
2. **Anomaly_Log**: 异常记录明细

---

### 4. 数据预览（调试用）

**POST** `/api/preview`

预览 Excel 文件的数据结构。

**请求：**
- Content-Type: `multipart/form-data`
- Body: `file` (Excel 文件)

**响应示例：**
```json
{
  "success": true,
  "data": {
    "attendance": {
      "columns": ["日期", "姓名", "一级部门", "当日状态判断", "工时"],
      "row_count": 1200,
      "sample_data": [...]
    },
    "flight": {
      "columns": ["授信金额", "项目", "预订人姓名", "差旅人员姓名", "出发日期"],
      "row_count": 450,
      "sample_data": [...]
    }
  },
  "message": "数据预览加载成功"
}
```

---

## 📋 数据字典

### 输入 Excel 文件概述

文件必须包含以下 Sheet：

- **状态明细**: 考勤数据（24,289 行 × 17 列）
- **机票**: 机票预订数据（975 行 × 27 列）
- **酒店**: 酒店预订数据（1,028 行 × 24 列）
- **火车票**: 火车票预订数据（686 行 × 20 列）

---

### 1. **状态明细**（考勤数据）

| 字段名 | 类型 | 空值率 | 说明 | 示例值 |
|--------|------|--------|------|--------|
| 日期 | string | 0% | 考勤日期，格式：YYYY/MM/DD | 2025/08/02 |
| 姓名 | string | 0% | 员工姓名 | 徐鸣 |
| 姓名计算值 | string | 0% | 姓名+日期唯一标识，用于数据关联 | 徐鸣 2025/08/02 |
| 一级部门 | string | 0% | 所属一级部门（17个唯一值） | 总裁办、平台研发部、通信网络部 |
| 二级部门 | string | 0% | 所属二级部门（64个唯一值） | 总裁办、项目专业组 |
| 三级部门 | string | 0% | 所属三级部门（113个唯一值） | 总裁办、姿轨控组 |
| 当日状态判断 | string | 0% | 考勤状态（7种：公休日、上班、出差、请假、未知、外出、公休日上班） | 公休日 |
| 备注 | float | 100% | 备注字段（当前全空） | - |
| 最早打卡时间 | string | 40.1% | 当日首次打卡时间 | 11:29:49 |
| 最晚打卡时间 | string | 40.1% | 当日最后打卡时间 | 19:36:27 |
| 工时 | float | 40.1% | 当日工作时长（小时） | 8.1 |
| 最晚19:30之后 | string | 80.5% | 是否在19:30之后打卡（仅"符合"） | 符合 |
| 钉钉休假与差旅 | string | 77.6% | 钉钉系统记录的休假或差旅状态 | 出差、请假 |
| 当日机票预定记录 | string | 96.9% | 当日机票预订记录（格式：姓名 日期） | 沈荣华 2025/08/03 |
| 当日火车票预定记录 | string | 98.0% | 当日火车票预订记录（格式：姓名 日期） | 万光明 2025/08/24 |
| 酒店记录 | float | 90.8% | 当日酒店记录（日期序列号） | 45893.0 |
| 当日滴滴打车记录 | string | 78.1% | 当日打车记录（格式：姓名 日期） | 万光明 2025/08/02 |

**注意**：部分字段（如当日机票预定记录、当日火车票预定记录）为关联字段，用于考勤与差旅数据的交叉验证。

---

### 2. **机票**（差旅数据）

| 字段名 | 类型 | 空值率 | 说明 | 示例值 |
|--------|------|--------|------|--------|
| 预订人姓名 | string | 0% | 预订机票的员工姓名 | 刘泽萌 |
| 订单号 | string | 0% | 差旅系统订单号（唯一标识） | DF250831135890611226 |
| 原订单号 | string | 89% | 改签/退票关联的原订单号 | DF250830135845393555 |
| 原始订单号 | string | 0% | 原始订单号（784个唯一值） | DF250831135890611226 |
| 订单状态 | string | 0% | 订单状态（4种：已出票、退票成功、改签成功、部分退票） | 已出票 |
| 差旅人员姓名 | string | 0% | 实际乘机人姓名 | 刘泽萌 |
| 姓名计算 | string | 21.6% | 姓名+起飞日期唯一标识 | 刘泽萌 2025/08/31 |
| 一级部门 | string | 3.3% | 预订人所属一级部门（16个唯一值） | 平台研发部 |
| 二级部门 | string | 3.3% | 预订人所属二级部门（55个唯一值） | 项目专业组 |
| 乘机人状态 | string | 0% | 乘机人状态（3种：已出票、已退票、改签成功） | 已出票 |
| 订单量 | int | 0% | 订单数量（1=新增，-1=退票，0=改签） | 1 |
| 是否超标 | string | 0% | 是否超标（是/否） | 否 |
| 起飞日期 | string | 0% | 起飞日期，格式：YYYY/MM/DD | 2025/08/31 |
| 出发时间 | string | 0% | 起飞时间（HH:MM） | 12:00 |
| 超标类型 | string | 58.1% | 超标类型（3种：超折扣、超时间、视同符合） | 超折扣 |
| 超标原因 | string | 67.7% | 超标原因说明 | 发射场工作 |
| 退改类型 | string | 89% | 退改类型（4种：自愿退票、自愿改期、非自愿退票、非自愿改期） | 自愿退票 |
| 退改原因 | string | 92% | 退改原因说明 | 自愿退票、航班取消 |
| 提前预定天数 | int | 0% | 提前预定天数（0-20天） | 0 |
| 起飞时间 | string | 0% | 完整起飞时间（YYYY-MM-DD HH:MM:SS） | 2025-08-31 12:00:00 |
| 到达时间 | string | 0% | 完整到达时间（YYYY-MM-DD HH:MM:SS） | 2025-08-31 14:30:00 |
| 航班类型 | string | 0% | 航班类型（国内/国际） | 国内 |
| 航段状态 | string | 0% | 航段状态（已出票/退票） | 已出票 |
| 授信金额 | float | 0% | 订单金额（元） | 1280.0 |
| 折扣 | float | 0% | 机票折扣率 | 5.6 |
| 行程 | string | 0% | 航线信息（出发地-目的地） | 长沙-北京 |
| 项目 | string | 9.9% | 项目信息（格式：项目代码 项目名称-日期） | 05010013 市场-整星-XX-灵知06(批产)-西安科技-250113 |

**项目字段解析规则**：
- 项目代码：空格前的8位数字（如 `05010013`）
- 项目名称：项目代码后的描述部分
- 日期：最后的日期标识（如 `250113`）

---

### 3. **酒店**（差旅数据）

| 字段名 | 类型 | 空值率 | 说明 | 示例值 |
|--------|------|--------|------|--------|
| 预订人姓名 | string | 0% | 预订酒店的员工姓名 | 刘嘉暄 |
| 订单号 | string | 0% | 差旅系统订单号（唯一标识） | HO20250827091200524040 |
| 原订单号 | float | 100% | 改签/退票关联的原订单号（当前全空） | - |
| 原始订单号 | string | 0% | 原始订单号 | HO20250827091200524040 |
| 订单状态 | string | 0% | 订单状态（2种：已离店、已退款） | 已离店 |
| 差旅人员姓名 | string | 0% | 实际入住人姓名 | 刘嘉暄 |
| 一级部门 | string | 2.7% | 预订人所属一级部门（14个唯一值） | 平台研发部 |
| 二级部门 | string | 2.7% | 预订人所属二级部门（47个唯一值） | 姿轨控组 |
| 差旅人部门 | string | 0.3% | 差旅人所属部门（97个唯一值） | 系统组 |
| 订单量 | float | 0.1% | 订单数量（正数=新增，负数=退票） | 3.0 |
| 是否超标 | string | 0.1% | 是否超标（是/否） | 否 |
| 超标项 | string | 90.7% | 超标项说明 | 连住平均房价319.00超出高峰的入住标准：280.00 |
| 超标选项 | string | 90.7% | 超标选项（固定值） | 写明工作事由、出行时间考虑、未选最低价的原因 |
| 超标原因 | string | 90.7% | 超标原因说明 | 超出部分自费 |
| 提前预定天数 | int | 0% | 提前预定天数（-1-19天） | 1 |
| 入住日期 | string | 0% | 入住日期（YYYY-MM-DD） | 2025-08-28 |
| 离店日期 | string | 0% | 离店日期（YYYY-MM-DD） | 2025-09-02 |
| 间夜数 | int | 0% | 入住天数（正数=新增，负数=退票） | 3 |
| 城市名称 | string | 0% | 酒店所在城市（34个城市） | 上海 |
| 酒店名称 | string | 0% | 酒店名称（266个唯一值） | 全季酒店(上海大学清河路店) |
| 房间数 | int | 0% | 预订房间数（固定值1） | 1 |
| 授信金额 | float | 0% | 订单金额（元，负数表示退票） | 732.0 |
| 行程 | string | 0% | 酒店信息（同酒店名称） | 全季酒店(上海大学清河路店) |
| 项目 | string | 4.2% | 项目信息（格式同机票） | 01000001 市场类-灵犀04卫星-第一轨(西安) |

---

### 4. **火车票**（差旅数据）

| 字段名 | 类型 | 空值率 | 说明 | 示例值 |
|--------|------|--------|------|--------|
| 预订人姓名 | string | 0% | 预订火车票的员工姓名 | 邓道聃 |
| 订单号 | string | 0% | 差旅系统订单号（唯一标识） | DT250829135712803296 |
| 原订单号 | string | 92.3% | 改签/退票关联的原订单号 | DT250826135114050497 |
| 原始订单号 | string | 0% | 原始订单号 | DT250829135712803296 |
| 订单状态 | string | 0% | 订单状态（4种：退票成功、部分退票、已出票、已改签） | 退票成功 |
| 差旅人员姓名 | string | 0% | 实际乘车人姓名 | 樊明国 |
| 姓名计算 | string | 18.7% | 姓名+出发日期唯一标识 | 李岩 2025/08/31 |
| 一级部门 | string | 3.5% | 预订人所属一级部门（13个唯一值） | 载荷毫米波部 |
| 二级部门 | string | 3.5% | 预订人所属二级部门（45个唯一值） | 工艺结构组 |
| 差旅人部门 | string | 0.3% | 差旅人所属部门（85个唯一值） | 工艺结构 |
| 订单量 | int | 0% | 订单数量（1=新增，-1=退票，0=改签） | -1 |
| 是否超标 | string | 0% | 是否超标（固定值：否） | 否 |
| 提前预定天数 | int | 0% | 提前预定天数（0-12天） | 2 |
| 出发日期 | string | 0% | 出发日期（YYYY-MM-DD） | 2025-08-31 |
| 到达日期 | string | 0% | 到达日期（YYYY-MM-DD） | 2025-08-31 |
| 出发时间 | string | 0% | 出发时间（HH:MM） | 22:30 |
| 到达时间 | string | 0% | 到达时间（HH:MM） | 22:58 |
| 授信金额 | float | 0% | 订单金额（元，负数表示退票） | -25.0 |
| 行程 | string | 0% | 车次路线（出发地-目的地） | 上海虹桥-嘉兴南 |
| 项目 | string | 2.9% | 项目信息（格式同机票） | 05030080 市场-单机-10502-Ka相控阵子阵-西安科技-250312 |

---

### 字段关联说明

#### 1. 考勤与差旅交叉验证

- **状态明细.当日机票预定记录** 与 **机票.姓名计算** 关联
- **状态明细.当日火车票预定记录** 与 **火车票.姓名计算** 关联
- **状态明细.酒店记录** 与 **酒店.入住日期** 关联（需日期转换）

#### 2. 项目代码提取规则

所有差旅 Sheet 的 `项目` 字段格式统一为：
```
{项目代码} {项目类型}-{项目名称}-{日期标识}
```

示例：`05010013 市场-整星-XX-灵知06(批产)-西安科技-250113`
- 项目代码：`05010013`（空格前的8位数字）
- 项目类型：`市场-整星`
- 项目名称：`XX-灵知06(批产)-西安科技`
- 日期标识：`250113`

---

### 数据质量说明

| Sheet | 总行数 | 有效数据行数 | 主要空值字段 |
|-------|--------|--------------|--------------|
| 状态明细 | 24,289 | ~14,500 (有打卡数据) | 最早打卡时间、最晚打卡时间、工时 (40.1%) |
| 机票 | 975 | 877 (排除改签/退票关联行) | 超标类型 (58.1%)、超标原因 (67.7%)、退改类型 (89%) |
| 酒店 | 1,028 | ~1,000 | 超标项/超标原因 (90.7%) |
| 火车票 | 686 | 550 (排除改签/退票关联行) | 原订单号 (92.3%) |

**注意**：订单量为 `-1` 或 `0` 的记录通常表示退票或改签，分析时需过滤或特殊处理。

---

### 解析脚本使用

项目提供了 `scripts/parse_excel_fields.py` 脚本，可用于解析任意 Excel 文件的字段信息：

```bash
# 使用后端虚拟环境执行
cd backend
source venv/bin/activate
python ../scripts/parse_excel_fields.py [文件路径]

# 示例：解析测试数据
python ../scripts/parse_excel_fields.py /path/to/test.xlsx
```

脚本会输出：
1. Markdown 格式的数据字典（标准输出）
2. JSON 格式的详细字段信息（保存为 `excel_fields.json`）

后续 Coding Agent 可直接执行该脚本获取最新的字段信息。

---

## 🔧 核心业务逻辑

### 1. 项目成本归集
- 从 `项目` 字段提取项目代码（空格前的数字）
- 聚合机票、酒店、火车票的 `授信金额`
- 按总成本降序排序，返回 Top 10

### 2. 交叉验证（异常检测）

#### 类型1: Conflict
- **逻辑**: 考勤显示 "上班"，但同日有异地差旅消费
- **风险**: 可能存在虚假报销或打卡异常

#### 类型2: NoExpense
- **逻辑**: 考勤显示 "出差"，但前后3天无任何差旅消费
- **风险**: 可能存在考勤录入错误或私人出行

### 3. 预订行为分析
- 统计 `提前预定天数 <= 2` 的订单比例
- 计算平均提前预定天数

### 4. 部门指标
- 部门总成本
- 部门总工时
- 人员数量
- 饱和度 = 总工时 / (人数 × 标准工时) × 100%

---

## 🛠️ 技术栈

- **Web 框架**: FastAPI 0.108.0
- **数据处理**: Pandas 2.1.4
- **Excel 操作**: OpenPyXL 3.1.2
- **异步服务器**: Uvicorn 0.25.0

---

## 📦 依赖说明

| 包名 | 版本 | 用途 |
|------|------|------|
| fastapi | 0.108.0 | Web 框架 |
| uvicorn | 0.25.0 | ASGI 服务器 |
| pandas | 2.1.4 | 数据分析 |
| openpyxl | 3.1.2 | Excel 读写 |
| python-multipart | 0.0.6 | 文件上传支持 |
| pydantic | 2.5.3 | 数据验证 |
| python-dateutil | 2.8.2 | 日期处理 |

---

## 🧪 测试指南

### 使用 cURL 测试

```bash
# 1. 健康检查
curl http://localhost:8000/health

# 2. 分析数据
curl -X POST http://localhost:8000/api/analyze \
  -F "file=@your_data.xlsx" \
  -o analysis_result.json

# 3. 导出文件
curl -X POST http://localhost:8000/api/export \
  -F "file=@your_data.xlsx" \
  -o result.xlsx
```

### 使用 Python Requests

```python
import requests

# 分析数据
with open('your_data.xlsx', 'rb') as f:
    response = requests.post(
        'http://localhost:8000/api/analyze',
        files={'file': f}
    )
    data = response.json()
    print(data)

# 导出文件
with open('your_data.xlsx', 'rb') as f:
    response = requests.post(
        'http://localhost:8000/api/export',
        files={'file': f}
    )
    with open('output.xlsx', 'wb') as out:
        out.write(response.content)
```

---

## ⚠️ 注意事项

### Excel 导出特别说明

本项目**必须使用 `openpyxl`** 来处理 Excel 导出，**禁止**使用 `pandas.to_excel()` 直接覆盖文件，原因：

1. ❌ `to_excel()` 会丢失原文件的样式、排版、公式
2. ✅ `openpyxl` 可以在原 Workbook 对象中追加 Sheet，保留所有原有格式

**正确做法：**
```python
# ✅ 正确
workbook = openpyxl.load_workbook(file_path)
new_sheet = workbook.create_sheet("Dashboard_Data")
# ... 写入数据 ...
workbook.save(output_path)

# ❌ 错误
df.to_excel(file_path, sheet_name="Dashboard_Data")  # 会覆盖原文件
```

---

## 🔒 数据安全

- 所有上传的文件仅保存在临时目录，处理完成后自动删除
- 不存储任何企业敏感数据
- 生产环境建议：
  - 配置 HTTPS
  - 限制 CORS 允许的域名
  - 添加身份认证中间件

---

## 📞 常见问题

### Q1: 服务启动失败？
**A**: 检查端口 8000 是否被占用：
```bash
lsof -i :8000
```

### Q2: Excel 文件解析失败？
**A**: 确保文件包含所有必需的 Sheet（状态明细、机票、酒店、火车票）

### Q3: 如何部署到生产环境？
**A**: 使用 Gunicorn + Uvicorn Workers：
```bash
gunicorn main:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000
```

---

## 📝 开发日志

- **v1.0.0** (2024-01): 初始版本
  - 实现数据加载、分析、导出功能
  - 支持项目成本归集、异常检测、预订行为分析
  - 完整的 API 文档和测试用例

---

## 额外说明
1. 平均工时与Excel计算不同的原因：Excel拉平均值排除0的情况

---

## 📄 License

本项目为企业内部工具，版权归银河航天所有。

---

## 👨‍💻 作者

GalaxySpace AI Team

如有问题请联系开发团队。
